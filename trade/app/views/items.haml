%h2 All Items

%form(action="/search/query" method="POST")
  %label.name
    %p Search the store
  %input.value(type="text" name="search" placeholder="Separate words with space")
  %hr.separator
    %input.rightalign.square(type="submit" value="Search")
%br
- content_for :name do
  #{title}
-unless @items.empty?
  -unless page ==1
    %a(href = "#{"javascript:changePage("+(page-1).to_s+")"}") previous
  -unless page_count==1
    -for i in 1..page_count
      -if page!=i
        %a(href = "#{"javascript:changePage("+i.to_s+")"}") #{i}
      -else
        #{i}
  -unless page == page_count
    %a(href = "#{"javascript:changePage("+(page+1).to_s+")"}") next
  -stored = @items
  %table.itemtable
    %thead
      %tr
        %td
          %p.table_header
            Name
            %a(href = "javascript:setSorting('name', 'asc');") &uarr;
            %a(href = "javascript:setSorting('name', 'desc');") &darr;
        %td
          %p.table_header Picture
        %td
          %p.table_header
            Price
            %a(href = "javascript:setSorting('price', 'asc');") &uarr;
            %a(href = "javascript:setSorting('price', 'desc');") &darr;
        %td
          %p.table_header Qty
        %td
          %p.table_header
            Seller
            %a(href = "javascript:setSorting('owner', 'asc');") &uarr;
            %a(href = "javascript:setSorting('owner', 'desc');") &darr;
        %td
          %p.table_header
            Seller rating
            %a(href = "javascript:setSorting('seller_rating', 'asc');") &uarr;
            %a(href = "javascript:setSorting('seller_rating', 'desc');") &darr;
        %td
          %p.table_header Buy
        %td
          %p.table_header Wishlist
    - for item in stored
      %tr(title = "#{item.description}")
        %td.nopadding
          %a.wholly_clickable(href="/item/#{item.id}" )
            :escaped
              #{item.name}
        %td
          %a(href="/item/#{item.id}/image" rel="lightbox" title="#{item.name}")
            %img(src="/item/#{item.id}/image" class = "smallpicturebox")
        %td
          %p #{item.price}
        %td
          %p #{item.quantity}
        %td
          %a(href="/users/#{item.owner.id}" )
            :escaped
              #{item.owner.name}
        %td
          %p #{item.owner.rating}
        %td.buyform
          -unless item.owner.id == User.get_user(session[:id]).working_for.id
            -if !item.auction
              -if item.quantity == 0
                %p Sold out! come back later
              -else
                %form.nomargin(action="/buy/#{item.id}/#{(stored.select {|tobuy| tobuy.id==item.id})[0].timestamp}" method="POST")
                  %input.tiny(type = "text" name = "quantity" value = "1")
                  %input.square.rightalign(type="submit" value="Buy")
            -else
              %a.wholly_clickable(href="/item/#{item.id}") See auction
        - if @session_user.wishlist.include?(item)
          %td
            %form.nomargin(action="/remove_from_wishlist/#{item.id}" method="POST")
              %input.square.rightalign(type="submit" value = "Remove from Wishlist")
        -else
          - if !item.owner.eql?(@session_user.working_for)
            %td
              %form.nomargin(action="/add_to_wishlist/#{item.id}" method="POST")
                %input.square.rightalign(type = "submit" value ="Add to wishlist")
-else
  %h3 No items